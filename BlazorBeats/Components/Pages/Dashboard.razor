@page "/dashboard"
@inject NavigationManager Nav
@inject UserSession Session
@inject BeatService BeatService
@inject BlazorBeats.Services.ProfileService ProfileService
@using BlazorBeats.Components.Data.Models
@using BlazorBeats.Components.Data
@using BlazorBeats.Services

<style>
    .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #222;
        color: white;
        padding: 1rem;
        flex-wrap: wrap;
    }

        .topbar .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .topbar .user-info img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }

    .nav-btn {
        background-color: #00aced;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

        .nav-btn:hover {
            background-color: #0084b4;
        }

    .logout-btn {
        background-color: #ff5c5c;
    }

        .logout-btn:hover {
            background-color: #e04646;
        }

    .content {
        padding: 2rem;
        background: #f0f0f0;
        min-height: calc(100vh - 80px);
        overflow-y: auto;
    }

    .beats-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }

    .beat-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: box-shadow 0.3s ease;
    }

        .beat-card:hover {
            box-shadow: 0 0 12px rgba(0,0,0,0.25);
        }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 400px;
        max-width: 90vw;
        padding: 1rem;
        box-shadow: 0 5px 15px rgba(0,0,0,.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #ddd;
    }

    .modal-body img.cover {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }

    .modal-footer {
        padding-top: 0.5rem;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 1rem 0;
    }

        .author-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

    .filters {
        margin-bottom: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
    }

        .filters input[type="text"],
        .filters input[type="number"],
        .filters select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        .filters button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            .filters button:hover {
                opacity: 0.9;
            }

        .filters .apply-btn {
            background-color: #00aced;
            color: white;
        }

        .filters .clear-btn {
            background-color: #ccc;
            color: black;
        }
</style>



<main class="content">
    <div class="filters">
        <input type="text" placeholder="Поиск по названию..." @bind="searchQuery" />
        <select @bind="selectedGenre">
            <option value="">Все жанры</option>
            @foreach (var genre in Genres)
            {
                <option value="@genre">@genre</option>
            }
        </select>
        <select @bind="selectedKey">
            <option value="">Все ключи</option>
            @foreach (var key in Keys)
            {
                <option value="@key">@key</option>
            }
        </select>
        <label>
            BPM:
            <input type="number" placeholder="от" @bind="minBpm" style="width: 60px;" />
            -
            <input type="number" placeholder="до" @bind="maxBpm" style="width: 60px;" />
        </label>
       
        <button class="apply-btn" @onclick="ApplyFilters">Применить</button>
        <button class="clear-btn" @onclick="ClearFilters">Очистить</button>
    </div>

    @if (FilteredBeats == null)
    {
        <p>Загрузка битов...</p>
    }
    else if (FilteredBeats.Count == 0)
    {
        <p>Биты не найдены.</p>
    }
    else
    {
        <div class="beats-list">
            @foreach (var beat in FilteredBeats)
            {
                <div class="beat-card" @onclick="() => OpenBeatModalAsync(beat)">
                    <img src="@beat.ImagePath" alt="Обложка бита" style="width: 100%; height: 120px; object-fit: cover; border-radius: 6px;" />
                    <h3>@beat.Title</h3>
                    <p><strong>Жанр:</strong> @beat.Genre</p>
                    
                    <p><strong>BPM:</strong> @beat.Bpm</p>
                    <p><strong>Ключ:</strong> @beat.Key</p>
                </div>
            }
        </div>
    }
</main>

@if (selectedBeat != null)
{
    <div class="modal-backdrop" @onclick="CloseBeatModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h5>@selectedBeat.Title</h5>
                <button class="btn btn-close" @onclick="CloseBeatModal"></button>
            </div>
            <div class="modal-body">
                <img src="@selectedBeat.ImagePath" class="cover" alt="Обложка бита" />
                <p><strong>Жанр:</strong> @selectedBeat.Genre</p>
                
                <p><strong>BPM:</strong> @selectedBeat.Bpm</p>
                <p><strong>Ключ:</strong> @selectedBeat.Key</p>

                @if (BeatAuthor != null)
                {
                    <div class="author-info">
                        <img src="@BeatAuthor.AvatarUrl" alt="Аватар автора" />
                        <strong>@BeatAuthor.Name</strong>
                    </div>
                }
                else
                {
                    <p>Автор не найден.</p>
                }

                <audio controls style="width: 100%;">
                    <source src="@selectedBeat.FileUrl" type="audio/mpeg" />
                    Ваш браузер не поддерживает аудиоплеер.
                </audio>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" @onclick="CloseBeatModal">Закрыть</button>
                <a href="@($"/purchase/{selectedBeat.Id}")" class="btn btn-primary mt-2">Приобрести</a>
            </div>
        </div>
    </div>
}

@code {
    private List<Beat> Beats = new();
    private List<Beat> FilteredBeats = new();
    private Beat? selectedBeat;
    private Profile? UserProfile;
    private Profile? BeatAuthor;

    private string searchQuery = string.Empty;
    private string selectedGenre = string.Empty;
    private string selectedKey = string.Empty;
    private int? minBpm = null;
    private int? maxBpm = null;
    private decimal? minPrice = null;
    private decimal? maxPrice = null;

    private List<string> Genres = new() { "Trap", "Boom Bap", "Drill", "RnB", "Lo-fi", "Pop", "EDM" };
    private List<string> Keys = new() { "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" };

    protected override async Task OnInitializedAsync()
    {
        Beats = await BeatService.GetAllBeatsAsync();
        FilteredBeats = Beats.ToList();

        if (Session.CurrentUser != null)
        {
            UserProfile = await ProfileService.GetProfileByUserIdAsync(Session.CurrentUser.Id);
        }
    }

    private void ApplyFilters()
    {
        FilteredBeats = Beats
            .Where(beat =>
                (string.IsNullOrWhiteSpace(searchQuery) || beat.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)) &&
                (string.IsNullOrWhiteSpace(selectedGenre) || beat.Genre == selectedGenre) &&
                (string.IsNullOrWhiteSpace(selectedKey) || beat.Key == selectedKey) &&
                (!minBpm.HasValue || (int.TryParse(beat.Bpm, out var bpm) && bpm >= minBpm.Value)) &&
                (!maxBpm.HasValue || (int.TryParse(beat.Bpm, out var bpm2) && bpm2 <= maxBpm.Value)) &&
                (!minPrice.HasValue || (decimal)beat.Price >= minPrice) &&
                (!maxPrice.HasValue || (decimal)beat.Price <= maxPrice)
            )
            .ToList();
    }

    private void ClearFilters()
    {
        searchQuery = string.Empty;
        selectedGenre = string.Empty;
        selectedKey = string.Empty;
        minBpm = null;
        maxBpm = null;
        minPrice = null;
        maxPrice = null;
        FilteredBeats = Beats.ToList();
    }

    private void Logout()
    {
        Session.Logout();
        Nav.NavigateTo("/login");
    }

    private async Task OpenBeatModalAsync(Beat beat)
    {
        selectedBeat = beat;
        BeatAuthor = await ProfileService.GetProfileByUserIdAsync(beat.UserId);
        StateHasChanged();
    }

    private void CloseBeatModal()
    {
        selectedBeat = null;
        BeatAuthor = null;
    }
}
