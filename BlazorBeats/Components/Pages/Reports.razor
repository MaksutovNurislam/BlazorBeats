@page "/reports"
@inject ReportService ReportService
@using BlazorBeats.Components.Layout
@layout AdminLayout

@using System.Globalization
@using Microsoft.AspNetCore.Components.Forms

<style>
    .report-container {
        padding: 1rem;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h2 {
        font-size: 2rem;
        margin-bottom: 1rem;
    }

    h3 {
        font-size: 1.5rem;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }

    ul {
        list-style-type: none;
        padding: 0;
    }

    li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #ddd;
    }

        li:last-child {
            border-bottom: none;
        }

    .form-control {
        display: inline-block;
        width: auto;
        margin: 0 0.5rem;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

        .btn-primary:hover {
            background-color: #0056b3;
        }

    .form-select {
        padding: 0.35rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-top: 0.5rem;
    }

    .income-display {
        font-size: 1.25rem;
        font-weight: bold;
        margin-top: 1rem;
        color: #333;
    }
</style>

<div class="report-container">
    <h2>📊 Отчёты</h2>

    <h3>Топ 10 продаваемых битов за месяц</h3>
    @if (TopBeats is not null)
    {
        <ul>
            @foreach (var beat in TopBeats)
            {
                <li>@beat.Title — @beat.SalesCount продаж</li>
            }
        </ul>
    }

    <h3>Доход платформы</h3>
    <p>
        Период:
        <InputDate @bind-Value="StartDate" class="form-control" style="width:150px" />
        —
        <InputDate @bind-Value="EndDate" class="form-control" style="width:150px" />
    </p>

    <button class="btn btn-primary mb-2" @onclick="LoadDataAsync">Обновить</button>
    <p class="income-display"><b>@PlatformIncome.ToString("C", CultureInfo.GetCultureInfo("en-US"))</b></p>

    <h3>Выплаты музыкантам</h3>
    @if (Sellers is not null)
    {
        <p>
            Фильтр по пользователю:
            <select @onchange="OnSellerChanged" class="form-select" style="width: 250px;">
                <option value="">Все</option>
                @foreach (var seller in Sellers)
                {
                    <option value="@seller.Id">@seller.DisplayName</option>
                }
            </select>


        </p>
    }

    @if (Payouts is not null)
    {
        <ul>
            @foreach (var payout in Payouts)
            {
                <img src="@payout.AvatarUrl" alt="@payout.DisplayName" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />
                <li>@payout.DisplayName — @payout.AmountPaid.ToString("C", CultureInfo.GetCultureInfo("en-US"))</li>
            }
        </ul>
    }
</div>

@code {
    private List<BeatSalesDto> TopBeats;
    private List<MusicianPayoutDto> Payouts;
    private List<UserDto> Sellers = new();
    private double PlatformIncome;

    private DateTime StartDate = DateTime.Today.AddDays(-30);
    private DateTime EndDate = DateTime.Today;

    private int? SelectedSellerId = null;

    protected override async Task OnInitializedAsync()
    {
        TopBeats = await ReportService.GetTopBeatsThisMonthAsync();
        Sellers = await ReportService.GetSellersAsync();
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        PlatformIncome = await ReportService.GetPlatformIncomeAsync(StartDate, EndDate);
        Payouts = await ReportService.GetMusicianPayoutsAsync(StartDate, EndDate, SelectedSellerId);
    }


    private async Task OnSellerChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var sellerId))
            SelectedSellerId = sellerId;
        else
            SelectedSellerId = null;

        await LoadDataAsync();
    }

}